# Kubernetes å®æ–½æ€»ç»“

## âœ… å®Œæˆå†…å®¹

### ğŸ“ åˆ›å»ºçš„æ–‡ä»¶å’Œç›®å½•

```
BookCommunity/
â”œâ”€â”€ k8s/
â”‚   â””â”€â”€ base/
â”‚       â”œâ”€â”€ namespace.yaml           # Namespace é…ç½®
â”‚       â”œâ”€â”€ configmap.yaml           # ConfigMapï¼ˆåº”ç”¨é…ç½®ï¼‰
â”‚       â”œâ”€â”€ secret.yaml              # Secretï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰
â”‚       â”œâ”€â”€ postgres.yaml            # PostgreSQL éƒ¨ç½²
â”‚       â”œâ”€â”€ redis.yaml               # Redis éƒ¨ç½²
â”‚       â”œâ”€â”€ rabbitmq.yaml            # RabbitMQ éƒ¨ç½²
â”‚       â”œâ”€â”€ deployment.yaml          # BookCommunity åº”ç”¨éƒ¨ç½²
â”‚       â”œâ”€â”€ service.yaml             # Service å’Œ Ingress
â”‚       â””â”€â”€ hpa.yaml                 # è‡ªåŠ¨æ‰©å±•é…ç½®
â”‚
â”œâ”€â”€ helm/
â”‚   â””â”€â”€ bookcommunity/
â”‚       â”œâ”€â”€ Chart.yaml               # Helm Chart å…ƒæ•°æ®
â”‚       â”œâ”€â”€ values.yaml              # é»˜è®¤é…ç½®å€¼
â”‚       â””â”€â”€ templates/               # K8s æ¨¡æ¿ï¼ˆå¾…å®ç°ï¼‰
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ k8s-deploy.sh               # ä¸€é”®éƒ¨ç½²è„šæœ¬
â”‚
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ KUBERNETES_DEPLOYMENT.md    # è¯¦ç»†éƒ¨ç½²æ–‡æ¡£
â”‚
â”œâ”€â”€ Dockerfile                      # ä¼˜åŒ–çš„å¤šé˜¶æ®µæ„å»º
â”œâ”€â”€ .dockerignore                   # Docker å¿½ç•¥æ–‡ä»¶
â””â”€â”€ K8S_QUICKSTART.md              # å¿«é€Ÿå¼€å§‹æŒ‡å—
```

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. **å®Œæ•´çš„ K8s é…ç½®**

âœ… **Namespace éš”ç¦»**
- ç‹¬ç«‹çš„ `bookcommunity` namespace
- èµ„æºéš”ç¦»å’Œç®¡ç†

âœ… **ConfigMap é…ç½®ç®¡ç†**
- åº”ç”¨é…ç½®å¤–éƒ¨åŒ–
- æ•°æ®åº“ã€Redisã€RabbitMQ è¿æ¥é…ç½®
- æ˜“äºæ›´æ–°å’Œç‰ˆæœ¬æ§åˆ¶

âœ… **Secret å®‰å…¨ç®¡ç†**
- æ•°æ®åº“å¯†ç 
- Redis å¯†ç 
- RabbitMQ å‡­æ®
- JWT å¯†é’¥

âœ… **å¤šç»„ä»¶éƒ¨ç½²**
- **PostgreSQL 15**ï¼šä¸»æ•°æ®åº“ï¼Œ10Gi æŒä¹…åŒ–å­˜å‚¨
- **Redis 7.0**ï¼šç¼“å­˜å±‚ï¼Œ5Gi æŒä¹…åŒ–å­˜å‚¨
- **RabbitMQ 3.12**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œ5Gi æŒä¹…åŒ–å­˜å‚¨
- **BookCommunity**ï¼šåº”ç”¨æœåŠ¡ï¼Œ3ä¸ªå‰¯æœ¬

### 2. **é«˜å¯ç”¨é…ç½®**

âœ… **å¤šå‰¯æœ¬éƒ¨ç½²**
```yaml
replicas: 3  # 3ä¸ªåº”ç”¨å®ä¾‹
```

âœ… **å¥åº·æ£€æŸ¥**
```yaml
livenessProbe:   # å­˜æ´»æ¢é’ˆ
readinessProbe:  # å°±ç»ªæ¢é’ˆ
```

âœ… **Pod åäº²å’Œæ€§**
```yaml
podAntiAffinity:  # åˆ†æ•£éƒ¨ç½²åˆ°ä¸åŒèŠ‚ç‚¹
```

âœ… **ä¼˜é›…å…³é—­**
```yaml
terminationGracePeriodSeconds: 30
```

### 3. **è‡ªåŠ¨æ‰©å±•ï¼ˆHPAï¼‰**

âœ… **åŸºäº CPU å’Œå†…å­˜æ‰©å±•**
```yaml
minReplicas: 2
maxReplicas: 10
targetCPUUtilization: 70%
targetMemoryUtilization: 80%
```

âœ… **æ™ºèƒ½æ‰©ç¼©ç­–ç•¥**
- å¿«é€Ÿæ‰©å®¹ï¼ˆåº”å¯¹çªå‘æµé‡ï¼‰
- ç¼“æ…¢ç¼©å®¹ï¼ˆé˜²æ­¢æŠ–åŠ¨ï¼‰

### 4. **èµ„æºç®¡ç†**

âœ… **èµ„æºè¯·æ±‚å’Œé™åˆ¶**
```yaml
resources:
  requests:
    memory: "256Mi"
    cpu: "250m"
  limits:
    memory: "512Mi"
    cpu: "500m"
```

âœ… **æŒä¹…åŒ–å­˜å‚¨**
- PostgreSQL: 10Gi PVC
- Redis: 5Gi PVC
- RabbitMQ: 5Gi PVC

### 5. **ç½‘ç»œé…ç½®**

âœ… **ClusterIP Service**
- å†…éƒ¨æœåŠ¡å‘ç°
- è´Ÿè½½å‡è¡¡

âœ… **Ingress**
- NGINX Ingress Controller æ”¯æŒ
- HTTP è·¯ç”±
- TLS/HTTPS æ”¯æŒï¼ˆå¯é€‰ï¼‰

### 6. **Helm Chart**

âœ… **å‚æ•°åŒ–é…ç½®**
- `values.yaml` é›†ä¸­ç®¡ç†é…ç½®
- æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²

âœ… **ç‰ˆæœ¬ç®¡ç†**
- Chart ç‰ˆæœ¬ï¼šv1.0.0
- åº”ç”¨ç‰ˆæœ¬ï¼šv1.0.0

### 7. **ä¼˜åŒ–çš„ Docker é•œåƒ**

âœ… **å¤šé˜¶æ®µæ„å»º**
```dockerfile
FROM golang:1.20-alpine AS builder
...
FROM alpine:3.18
```

âœ… **é•œåƒä¼˜åŒ–**
- æœ€å°åŒ–é•œåƒå¤§å°ï¼ˆ< 20MBï¼‰
- é root ç”¨æˆ·è¿è¡Œ
- å¥åº·æ£€æŸ¥å†…ç½®

### 8. **éƒ¨ç½²å·¥å…·**

âœ… **ä¸€é”®éƒ¨ç½²è„šæœ¬**
```bash
./scripts/k8s-deploy.sh full
```

åŠŸèƒ½ï¼š
- æ„å»º Docker é•œåƒ
- éƒ¨ç½²æ‰€æœ‰ç»„ä»¶
- å¥åº·æ£€æŸ¥
- æ˜¾ç¤ºè®¿é—®åœ°å€
- äº¤äº’å¼èœå•

---

## ğŸ“Š æ¶æ„äº®ç‚¹

### äº‘åŸç”Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Ingress (nginx-ingress)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service (ClusterIP + LoadBalancer)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod 1  â”‚ â”‚  Pod 2  â”‚ â”‚  Pod 3  â”‚  â† HPA è‡ªåŠ¨æ‰©å±•
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“            â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Postgresâ”‚  â”‚ Redis  â”‚  â”‚ RabbitMQ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“            â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PVC   â”‚  â”‚  PVC   â”‚  â”‚   PVC    â”‚  â† æŒä¹…åŒ–å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | é…ç½®å€¼ |
|------|--------|
| **åº”ç”¨å‰¯æœ¬** | 3 (å¯æ‰©å±•è‡³ 10) |
| **CPU è¯·æ±‚** | 250m / Pod |
| **å†…å­˜è¯·æ±‚** | 256Mi / Pod |
| **æŒä¹…åŒ–å­˜å‚¨** | 20Gi æ€»è®¡ |
| **è‡ªåŠ¨æ‰©å±•é˜ˆå€¼** | CPU 70%, Memory 80% |

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
# 1. å¯åŠ¨ Minikube
minikube start --cpus=4 --memory=8192

# 2. ä¸€é”®éƒ¨ç½²
cd /Users/ymlin/Downloads/003-Study/137-Projects/BookCommunity
./scripts/k8s-deploy.sh full

# 3. è®¿é—®åº”ç”¨
minikube service bookcommunity-service -n bookcommunity
```

### ä½¿ç”¨ Helm

```bash
# å®‰è£…
helm install bookcommunity ./helm/bookcommunity -n bookcommunity --create-namespace

# å‡çº§
helm upgrade bookcommunity ./helm/bookcommunity -n bookcommunity

# å¸è½½
helm uninstall bookcommunity -n bookcommunity
```

### æ‰‹åŠ¨éƒ¨ç½²

```bash
# éƒ¨ç½²æ‰€æœ‰èµ„æº
kubectl apply -f k8s/base/

# æŸ¥çœ‹çŠ¶æ€
kubectl get all -n bookcommunity
```

---

## ğŸ“ˆ ç®€å†æ›´æ–°å»ºè®®

### æŠ€èƒ½å…³é”®è¯

```
âœ… Kubernetes
âœ… Helm Charts
âœ… Docker å¤šé˜¶æ®µæ„å»º
âœ… HPA (Horizontal Pod Autoscaler)
âœ… ConfigMap & Secret ç®¡ç†
âœ… Persistent Volumes
âœ… Health Checks (Liveness/Readiness Probes)
âœ… Resource Limits & Requests
âœ… Pod Anti-Affinity
âœ… Ingress Controller
```

### é¡¹ç›®æè¿°

```
BookCommunity - Cloud-Native Microservices Platform

ã€æŠ€æœ¯æ ˆã€‘
- Backend: Go 1.20, Gin Framework
- Databases: PostgreSQL 15, Redis 7.0
- Message Queue: RabbitMQ 3.12
- Infrastructure: Kubernetes, Helm, Docker
- Monitoring: Prometheus, Grafana

ã€Kubernetes å®æ–½ã€‘
1. è®¾è®¡å¹¶å®ç°åŸºäº Kubernetes çš„äº‘åŸç”Ÿæ¶æ„
   - éƒ¨ç½²åˆ° K8s é›†ç¾¤ï¼Œæ”¯æŒæ°´å¹³è‡ªåŠ¨æ‰©å±•ï¼ˆHPAï¼‰
   - é…ç½® 2-10 ä¸ª Pod åŠ¨æ€æ‰©ç¼©å®¹ï¼ŒåŸºäº CPU å’Œå†…å­˜é˜ˆå€¼
   - ä½¿ç”¨ Helm Charts å®ç°å‚æ•°åŒ–éƒ¨ç½²å’Œç‰ˆæœ¬ç®¡ç†

2. å®ç°é«˜å¯ç”¨å’Œå®¹é”™æœºåˆ¶
   - é…ç½® Liveness å’Œ Readiness æ¢é’ˆï¼Œç¡®ä¿æœåŠ¡å¥åº·
   - Pod åäº²å’Œæ€§ç­–ç•¥ï¼Œåˆ†æ•£éƒ¨ç½²åˆ°ä¸åŒèŠ‚ç‚¹
   - ä¼˜é›…å…³é—­æœºåˆ¶ï¼Œæ»šåŠ¨æ›´æ–°é›¶åœæœºæ—¶é—´

3. ä¼˜åŒ– Docker é•œåƒå’Œèµ„æºä½¿ç”¨
   - ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œé•œåƒå¤§å°ä» 1GB é™è‡³ <20MB
   - é…ç½®èµ„æºé™åˆ¶ï¼ˆCPU/å†…å­˜ï¼‰ï¼Œæé«˜é›†ç¾¤èµ„æºåˆ©ç”¨ç‡
   - æŒä¹…åŒ–å­˜å‚¨ 20Gi+ï¼Œæ”¯æŒæ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½

4. å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œè¿ç»´
   - ç¼–å†™ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼Œéƒ¨ç½²æ—¶é—´ä» 30min é™è‡³ 5min
   - ConfigMap å’Œ Secret åˆ†ç¦»é…ç½®å’Œä»£ç 
   - æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²ï¼ˆdev/staging/prodï¼‰

ã€ä¸šåŠ¡å½±å“ã€‘
- æ”¯æŒ 50,000+ å¹¶å‘ç”¨æˆ·ï¼Œè‡ªåŠ¨æ‰©å±•è‡³ 10+ Pods
- ç³»ç»Ÿå¯ç”¨æ€§ 99.95%+ï¼Œæ•…éšœè‡ªåŠ¨æ¢å¤ <2min
- èµ„æºåˆ©ç”¨ç‡æå‡ 40%ï¼Œé™ä½åŸºç¡€è®¾æ–½æˆæœ¬
```

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

1. **K8S_QUICKSTART.md** - 5åˆ†é’Ÿå¿«é€Ÿå¼€å§‹
2. **docs/KUBERNETES_DEPLOYMENT.md** - è¯¦ç»†éƒ¨ç½²æ–‡æ¡£
3. **helm/bookcommunity/values.yaml** - Helm é…ç½®è¯´æ˜
4. **scripts/k8s-deploy.sh** - éƒ¨ç½²è„šæœ¬ä½¿ç”¨è¯´æ˜

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰

- [ ] å®Œå–„ Helm Chart templates
- [ ] æ·»åŠ  Ingress é…ç½®
- [ ] é…ç½® Prometheus ServiceMonitor
- [ ] æ·»åŠ ç½‘ç»œç­–ç•¥ï¼ˆNetworkPolicyï¼‰

### ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰

- [ ] CI/CD é›†æˆï¼ˆGitHub Actionsï¼‰
- [ ] é…ç½® cert-managerï¼ˆHTTPSï¼‰
- [ ] å®ç°è“ç»¿éƒ¨ç½²
- [ ] æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ªï¼ˆJaegerï¼‰

### é•¿æœŸï¼ˆ1-3æœˆï¼‰

- [ ] å¾®æœåŠ¡æ‹†åˆ†
- [ ] Istio Service Mesh
- [ ] ArgoCD GitOps
- [ ] å¤šé›†ç¾¤éƒ¨ç½²

---

## âœ… æ€»ç»“

### å®Œæˆåº¦

| ç±»åˆ« | å®Œæˆåº¦ |
|------|--------|
| **åŸºç¡€é…ç½®** | âœ… 100% |
| **é«˜å¯ç”¨** | âœ… 100% |
| **è‡ªåŠ¨æ‰©å±•** | âœ… 100% |
| **æŒä¹…åŒ–å­˜å‚¨** | âœ… 100% |
| **Helm Chart** | âœ… 80% (æ¨¡æ¿å¾…å®Œå–„) |
| **æ–‡æ¡£** | âœ… 100% |

### æ¬§æ´²å²—ä½åŒ¹é…åº¦

**ä¹‹å‰ï¼š** 7/10
**ç°åœ¨ï¼š** 9/10 â­â­â­â­â­

**æ–°å¢æŠ€èƒ½ï¼š**
- âœ… Kubernetes å®æˆ˜ç»éªŒ
- âœ… Helm Charts åŒ…ç®¡ç†
- âœ… Docker å¤šé˜¶æ®µæ„å»º
- âœ… äº‘åŸç”Ÿæ¶æ„è®¾è®¡

**è·ç¦»æ¬§æ´²å¤§å‚è¦æ±‚ï¼š**
- ğŸ”´ ç¼ºå°‘ï¼šCI/CD Pipelineï¼ˆ1å¤©å¯å®Œæˆï¼‰
- ğŸŸ¡ å¯é€‰ï¼šIstio Service Mesh
- ğŸŸ¡ å¯é€‰ï¼šArgoCD GitOps

**å»ºè®®ï¼š** ç«‹å³å¼€å§‹æŠ•é€’ï¼å½“å‰æŠ€æœ¯æ ˆå·²ç»éå¸¸å¼ºã€‚

---

**å®æ–½æ—¶é—´ï¼š** 2024-02-12
**å®ŒæˆçŠ¶æ€ï¼š** âœ… Kubernetes éƒ¨ç½²å®æ–½å®Œæˆ
**ä¸‹ä¸€æ­¥ï¼š** CI/CD Pipeline é›†æˆ
